---
title: "check_hbhi_sim_output"
author: "Monique Ambrose"
date: "8/6/2020"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    number_sections: true
---


# Introduction 


This document creates a series of plots and comparisons of hbhi simulation output to assist in the detection of errors. 

We look at some basic information about the simulated populations and envirnoment, such as human and vector population sizes, temperature, and rainfall. We also look at intervention coverages and compare the interventions delivered in the simulations to what was specified in the intervention input files. Finally, we plot how various indicators of malaria burden change through time in the simulation.


## Setup

Specify which experiment to use and the intervention input files for that experiment.


```{r specify_experiment_info, message=FALSE, warning=FALSE, echo=FALSE}

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# -                               Setup                                 - #
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

library(data.table)
library(dplyr)
library(tidyr)
library(ggplot2)
library(RColorBrewer)
library(gridExtra)
library(rgdal)
library(raster)


# set base filepaths
base_filepath_scripts = 'C:/Users/mambrose/Documents/hbhi-spatial-clustering'

# which country shoul be used
country_name = 'Burundi'
# simulation years
start_year = 2010
end_year = 2020  # 2019, 2025, 2030
start_year = 2021
end_year = 2030  # 2019, 2025, 2030
if(country_name == 'Burundi'){
  hbhi_dir = 'C:/Users/mambrose/Dropbox (IDM)/Malaria Team Folder/projects/burundi_hbhi'

  # # past
  # # simulation output filepath and intervention input file
  # simulation_filepath = paste0(hbhi_dir, '/simulation_output/simulations_to_present/BDI_2010_2020_allInter')
  # intervention_csv_filename = paste0(hbhi_dir, '/simulation_inputs/_intervention_file_references/Interventions_for_2010_2020.csv')
  # # name for this simulation set used in intervention csv file
  # experiment_intervention_name = "BDI_2010_2020_allInter"
  
  # future projection
  # simulation output filepath and intervention input file
  simulation_filepath = paste0(hbhi_dir, '/simulation_output/simulations_future/BDI_projection_64pyr')
  intervention_csv_filename = paste0(hbhi_dir, '/simulation_inputs/_intervention_file_references/Interventions_for_projections.csv')
  # name for this simulation set used in intervention csv file
  experiment_intervention_name = "BDI_projection_64pyr"
  
  

  intervention_intermediate_path = ''
  ds_shapefile_filepath = paste0(hbhi_dir, '/SpatialClustering/reference_rasters_shapefiles/bdi_adm2.shp')

} else if(country_name == 'Burkina'){
  hbhi_dir = 'C:/Users/mambrose/Box/hbhi_burkina'
  # simulation output filepath and intervention input file
  simulation_filepath = paste0(hbhi_dir, '/simulation_output/2010_to_2020/_v18/BF 2010_2020 allInterventions')
  intervention_csv_filename = paste0(hbhi_dir, '/simulation_inputs/_scenarios_ms/Intervention_scenarios_2010_2019.csv')
  intervention_intermediate_path = ''
  # name for this simulation set used in intervention csv file
  experiment_intervention_name = "BF 2010_2020 allInterventions v18"

  ds_shapefile_filepath = paste(hbhi_dir,'/SpatialClustering_BF/reference_rasters_shapefiles/BF_DS_clusteringProjection.shp', sep='')

} else if(country_name == 'Nigeria'){
  hbhi_dir = 'C:/Users/mambrose/Box/hbhi_nigeria'

  # # 2010-2020
  # # simulation output filepath and intervention input file
  # simulation_filepath = paste0(hbhi_dir, '/simulation_output/2010_to_2020_v10/NGA 2010-20 burnin_hs+itn+smc')
  # intervention_csv_filename = paste0(hbhi_dir, '/simulation_inputs/projection_csvs/2010_2020_LGA_intervention_files/Intervention_scenarios_past_estimates.csv')
  # intervention_intermediate_path = ''
  # # name for this simulation set used in intervention csv file
  # experiment_intervention_name = "NGA 2010_2020 allInterventions v10"
  
  # # 2020-2030
  #   # simulation output filepath and intervention input file
  # simulation_filepath = paste0(hbhi_dir, '/simulation_output/2020_to_2030_test4/NGA projection scenario 7')
  # intervention_csv_filename = paste0(hbhi_dir, '/simulation_inputs/projection_csvs/projection_v2/Intervention_scenarios_nigeria_v3.csv')
  # intervention_intermediate_path = 'projection_csvs/projection_v2/'
  # # name for this simulation set used in intervention csv file
  # experiment_intervention_name = "NGA projection scenario 7"
  
  # 2010-2030
  # simulation output filepath and intervention input file
  simulation_filepath = paste0(hbhi_dir, '/simulation_output/2010_to_2030_immunity_Enugu/NGA immunity Enugu sc1')
  intervention_csv_filename = paste0(hbhi_dir, '/simulation_inputs/projection_csvs/rebound_immunity/Intervention_scenarios_immunity_rebound.csv')
  intervention_intermediate_path = 'projection_csvs/rebound_immunity/'
  # name for this simulation set used in intervention csv file
  experiment_intervention_name = "NGA immunity sc1"
  
  
  ds_shapefile_filepath = paste(hbhi_dir,'/SpatialClustering/reference_rasters_shapefiles/NGA_DS_clusteringProjection.shp', sep='')
}



plot_map_flag=TRUE

cat('Experiment output plotted for: ', simulation_filepath, '\n Intervention information from: ', intervention_csv_filename, '\n Start year: ', start_year, '\n End year: ', end_year)



# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# -                      Read in relevant files                         - #
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #

####   Simulation output files   ####
# read in simulation output files
pfpr_case_all = fread(paste0(simulation_filepath, '/All_Age_monthly_Cases.csv'))
pfpr_case_all[,date:=as.Date(date)]
pfpr_case_all$year = lubridate::year(pfpr_case_all$date)
pfpr_case_all = pfpr_case_all[pfpr_case_all$year<=end_year,]
pfpr_case_all = pfpr_case_all[pfpr_case_all$year>=start_year,]
colnames(pfpr_case_all) = gsub(' ', '_', colnames(pfpr_case_all))
pfpr_case_all$New_Clinical_Cases = pfpr_case_all$New_Clinical_Cases / pfpr_case_all$Statistical_Population * 12 * 1000  # convert to annual clinical incidence (per 1000)
colnames(pfpr_case_all)[colnames(pfpr_case_all) == 'LGA'] = 'admin_name'
colnames(pfpr_case_all)[colnames(pfpr_case_all) == 'DS_Name'] = 'admin_name'

pfpr_case_u5 = fread(paste0(simulation_filepath, '/U5_PfPR_ClinicalIncidence_severeTreatment.csv'))
pfpr_case_u5[,date:=as.Date(paste0(year,"-",month,"-01"),format="%Y-%m-%d")]
pfpr_case_u5 = pfpr_case_u5[pfpr_case_u5$year<=end_year,]
pfpr_case_u5 = pfpr_case_u5[pfpr_case_u5$year>=start_year,]
colnames(pfpr_case_u5) = gsub(' ', '_', colnames(pfpr_case_u5))
pfpr_case_u5$Cases_U5 = pfpr_case_u5$Cases_U5 *30/365 * 12 * 1000  # convert to annual clinical incidence (per 1000)
colnames(pfpr_case_u5)[colnames(pfpr_case_u5) == 'LGA'] = 'admin_name'
colnames(pfpr_case_u5)[colnames(pfpr_case_u5) == 'DS_Name'] = 'admin_name'

# read in information about the interventions distributed during the simulation
if(file.exists(paste0(simulation_filepath, '/monthly_Event_Count.csv'))){
  intervention_count = fread(paste0(simulation_filepath, '/monthly_Event_Count.csv'))
} else if(file.exists(paste0(simulation_filepath, '/monthly_Event_Count_ITN_SMC_IRS.csv'))){
  intervention_count_treatment = fread(paste0(simulation_filepath, '/monthly_Event_Count_Treatment.csv'))
  intervention_count_ITN_SMC_IRS = fread(paste0(simulation_filepath, '/monthly_Event_Count_ITN_SMC_IRS.csv'))
  intervention_count = merge(intervention_count_treatment, intervention_count_ITN_SMC_IRS, all.x=TRUE, all.y=TRUE)
} else if(file.exists(paste0(simulation_filepath, '/monthly_Event_Count_ITN.csv'))){
  intervention_count_treatment = fread(paste0(simulation_filepath, '/monthly_Event_Count_Treatment.csv'))
  intervention_count_STreatment_NMF = fread(paste0(simulation_filepath, '/monthly_Event_Count_STreatment_NMF.csv'))
  intervention_count_treatment = merge(intervention_count_treatment, intervention_count_STreatment_NMF, all.x=TRUE, all.y=TRUE)
  intervention_count_ITN = fread(paste0(simulation_filepath, '/monthly_Event_Count_ITN.csv'))
  intervention_count_SMC_IRS = fread(paste0(simulation_filepath, '/monthly_Event_Count_SMC_IRS.csv'))
  intervention_count_ITN_SMC_IRS = merge(intervention_count_ITN, intervention_count_SMC_IRS, all.x=TRUE, all.y=TRUE)
  intervention_count = merge(intervention_count_treatment, intervention_count_ITN_SMC_IRS, all.x=TRUE, all.y=TRUE)
}else{
  warning('necessary intervention event files not found')
}
intervention_count[,date:=as.Date(date)]
intervention_count$year = lubridate::year(intervention_count$date)
intervention_count = intervention_count[intervention_count$year<=end_year,]
intervention_count = intervention_count[intervention_count$year>=start_year,]
colnames(intervention_count)[colnames(intervention_count) == 'LGA'] = 'admin_name'
colnames(intervention_count)[colnames(intervention_count) == 'DS_Name'] = 'admin_name'

print(paste('Number of admins with interventions: ', length(unique(intervention_count$admin_name))))

# check whether vector file exists
if (file.exists(paste0(simulation_filepath, '/vector_numbers_monthly.csv'))){
  vectors_df = fread(paste0(simulation_filepath, '/vector_numbers_monthly.csv'))
  vectors_df[,date:=as.Date(date)]
  vectors_df$year = lubridate::year(vectors_df$date)
  vectors_df$month = lubridate::month(vectors_df$date)
  vectors_df = vectors_df[vectors_df$year<=end_year,]
  vectors_df = vectors_df[vectors_df$year>=start_year,]
  colnames(vectors_df)[colnames(vectors_df) == 'LGA'] = 'admin_name'

  show_vector_checks = TRUE
} else  show_vector_checks = FALSE


####   input files   ####
# read in intervention input files
intervention_file_info = read.csv(intervention_csv_filename)
cur_int_row = which(intervention_file_info$ScenarioName == experiment_intervention_name)
# read in intervention files
cm_input = read.csv(paste0(hbhi_dir, '/simulation_inputs/', intervention_intermediate_path, intervention_file_info$CM_filename[cur_int_row], '.csv'))
if(file.exists(paste0(hbhi_dir, '/simulation_inputs/', intervention_intermediate_path, intervention_file_info$SMC_filename[cur_int_row], '.csv'))) {
  smc_input = read.csv(paste0(hbhi_dir, '/simulation_inputs/', intervention_intermediate_path, intervention_file_info$SMC_filename[cur_int_row], '.csv'))
  plot_smc = TRUE
} else plot_smc = FALSE
anc_llin_input = read.csv(paste0(hbhi_dir, '/simulation_inputs/', intervention_intermediate_path, intervention_file_info$ANC_ITN_filename[cur_int_row], '.csv'))
epi_llin_input = read.csv(paste0(hbhi_dir, '/simulation_inputs/', intervention_intermediate_path, intervention_file_info$EPI_ITN_filename[cur_int_row], '.csv'))
mass_llin_input = read.csv(paste0(hbhi_dir, '/simulation_inputs/', intervention_intermediate_path, intervention_file_info$ITN_filename[cur_int_row], '.csv'))
if(file.exists(paste0(hbhi_dir, '/simulation_inputs/', intervention_intermediate_path, intervention_file_info$IRS_filename[cur_int_row], '.csv'))){
  irs_input = read.csv(paste0(hbhi_dir, '/simulation_inputs/', intervention_intermediate_path, intervention_file_info$IRS_filename[cur_int_row], '.csv'))
  plot_irs = TRUE
} else plot_irs = FALSE
# iptp_input = read.csv()
# arch9 = read.csv()
# colnames(cm_input)[colnames(cm_input) == 'LGA'] = 'admin_name'
# colnames(cm_input)[colnames(cm_input) == 'repDS'] = 'admin_name'
# colnames(smc_input)[colnames(smc_input) == 'LGA'] = 'admin_name'
# colnames(anc_llin_input)[colnames(anc_llin_input) == 'LGA'] = 'admin_name'
# colnames(anc_llin_input)[colnames(anc_llin_input) == 'block_initial']  = 'blocking_rate'
# colnames(mass_llin_input)[colnames(mass_llin_input) == 'LGA'] = 'admin_name'
# colnames(mass_llin_input)[colnames(mass_llin_input) == 'District'] = 'admin_name'
# colnames(mass_llin_input)[colnames(mass_llin_input) == 'ITN_child'] = 'U5_ITN_use'
# colnames(mass_llin_input)[colnames(mass_llin_input) == 'ITN_U10'] = 'six_nine_ITN_use'
# colnames(mass_llin_input)[colnames(mass_llin_input) == 'over_eighteen_ITN_use'] = 'adult_ITN_use'
# colnames(mass_llin_input)[colnames(mass_llin_input) == 'ITN_adult'] = 'adult_ITN_use'

# CM is sometimes repeated for several years but only listed once; change to repeate the appropriate number of times
cm_input$years_repeated = cm_input$duration/365
if(any(cm_input$years_repeated>1)){
  cur_cm_years = unique(cm_input$year)
  for(yy in cur_cm_years){
    # get first instance of this year
    cur_year = cm_input[cm_input$year==yy,]
    if(cur_year$years_repeated[1]>1){
      for(rr in 1:(cur_year$years_repeated[1] - 1)){
        temp_year = cur_year
        temp_year$year = cur_year$year + rr
        temp_year$simday = cur_year$simday + rr*365
        cm_input = rbind(cm_input, temp_year)
      }
    }
  }
}
if(any(cm_input$duration==-1) & (max(cm_input$year)<end_year)){
  cm_repeated = cm_input[cm_input$duration == -1,]
  for(rr in 1:(end_year - cm_repeated$year[1])){
    temp_year = cm_repeated
    temp_year$year = cm_repeated$year + rr
    temp_year$simday = cm_repeated$simday + rr*365
    cm_input = rbind(cm_input, temp_year)
  }
}
# if there are multiple values in a single year (for a single DS/LGA), take the mean of those values
cm_input <- cm_input %>% group_by(year, admin_name) %>%  
  summarise_all(mean) %>% ungroup() 

# read in shapefile
ds_shapefile = shapefile(ds_shapefile_filepath)





# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #
# -          Means across runs, years, admins, etc.                     - #
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - #


# mean values across runs (separate ds)
pfpr_case_all_runMeans  <- pfpr_case_all %>% group_by(date, admin_name) %>%  
  summarise_all(mean) %>% ungroup() 
pfpr_case_u5_runMeans  <- pfpr_case_u5 %>% group_by(date, admin_name) %>%  
  summarise_all(mean) %>% ungroup() 

#  mean annual average across all runs (separate ds)
pfpr_case_all_runMeans_annual  <- pfpr_case_all %>% group_by(year, admin_name) %>%  
  summarise_all(mean) %>% ungroup() 
pfpr_case_u5_runMeans_annual  <- pfpr_case_u5 %>% group_by(year, admin_name) %>%  
  summarise_all(mean) %>% ungroup() 

# mean value across all runs and all ds (not weighted by pop size)
pfpr_case_all_mean  <- pfpr_case_all %>% group_by(date) %>%  
  summarise_all(mean) %>% ungroup() 
pfpr_case_u5_mean  <- pfpr_case_u5 %>% group_by(date) %>%  
  summarise_all(mean) %>% ungroup() 

#  annual average across all runs and ds
pfpr_case_all_annual  <- pfpr_case_all %>% group_by(year) %>%  
  summarise_all(mean) %>% ungroup() 
pfpr_case_u5_annual  <- pfpr_case_u5 %>% group_by(year) %>%  
  summarise_all(mean) %>% ungroup() 

#  annual average across all runs, broken out by ds
pfpr_case_u5_annual_DS  <- pfpr_case_u5 %>% group_by(year, admin_name) %>%  
  summarise_all(mean) %>% ungroup() 
pfpr_case_all_annual_DS  <- pfpr_case_all %>% group_by(year, admin_name) %>%  
  summarise_all(mean) %>% ungroup() 

if(show_vector_checks){# vectors mean
  vectors_df_monthly = vectors_df %>% group_by(date, admin_name) %>%  
    summarise_all(mean) %>% ungroup() 
  vectors_df_monthly_mean = vectors_df %>% group_by(date) %>%  
    summarise_all(mean) %>% ungroup() 
  vectors_annual_mean = vectors_df %>% group_by(year, admin_name) %>%  
    summarise_all(mean) %>% ungroup() 
}



intervention_count_runMeans  <- intervention_count %>% group_by(date, admin_name) %>%  
  summarise_all(mean) %>% ungroup() 
intervention_count_runMeans = as.data.table(intervention_count_runMeans)
intervention_count_runMeans_annual  <- intervention_count_runMeans[, .SD, .SDcols = !c("date", "Run_Number")] %>% group_by(year, admin_name) %>%  
  summarise_all(sum) %>% ungroup() 

```

</br>

</br>

</br>

# Basic simulation properties and behavior

## Vector population size


```{r plot_vector_pop_size_sim, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}
ggplot(vectors_df_monthly, aes(x=date, y=`Adult Vectors`, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  ggtitle('Mean vector population size in each admin through time') + 
  theme(legend.position = "none")
ggplot(vectors_df_monthly_mean, aes(x=date, y=`Adult Vectors`)) +
  geom_line() + 
  ggtitle('Mean vector population size across all admins through time') + 
  theme(legend.position = "none")

```

```{r plot_vector_pop_size_sim_scatter, message=FALSE, warning=FALSE, echo=FALSE, fig.width=8, fig.height=7}
# compare pairs of years that are three years apart (the period for LLIN distribution)
vectors_annual_mean_wide <- spread(vectors_annual_mean[,c('year','admin_name','Adult Vectors')], year, `Adult Vectors`)
colnames(vectors_annual_mean_wide)[2:length(colnames(vectors_annual_mean_wide))] = paste0('year_', colnames(vectors_annual_mean_wide)[2:length(colnames(vectors_annual_mean_wide))])
pp_list = list()
counter = 1
for(yy in seq(start_year, end_year-3)){
  y2 = yy + 3
  
  pp_list[[counter]] = ggplot(vectors_annual_mean_wide, aes_string(x=paste0('year_',yy), y=paste0('year_',y2))) +
    geom_point(aes(color=admin_name))  +
    # geom_text(aes(label=admin_name), size=2, hjust='right', vjust='bottom')+
    geom_abline(slope = 1, intercept=0, col='grey') + 
    xlab(paste0('ave vector pop in ', yy)) + 
    ylab(paste0('ave vector pop in ', y2)) +
    theme(legend.position = "none")
  counter = counter + 1
}

do.call(grid.arrange, pp_list)

```


</br>


## Human population size
```{r plot_human_pop_size_sim, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}

# statistical population
ggplot(pfpr_case_all_runMeans, aes(x=date, y=Statistical_Population, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  ggtitle('Mean human population size in each admin through time') + 
  theme(legend.position = "none")


```

</br>


## Climate
Not currently pulled down from COMPS, sorry... need to check online.
</br>



</br>

# Intervention delivery



</br>


## Timeseries of intervention coverage in input files

### Case management

```{r input_interventions_cm, message=FALSE, warning=FALSE, echo=FALSE, fig.width=3, fig.height=3}


# function to create coverage maps
create_coverage_map = function(cov_df, ds_colname, value_colname, year_colname, years_include, ds_shapefile, shapefile_ds_colname, colorscale, numcolors, min_value, max_value, pdf_filename=''){
  if(pdf_filename != '') pdf(pdf_filename, width=12, height=6/4*3, useDingbats = FALSE)

    for(yy in 1:length(years_include)){
      # subset to appropriate year
      cov_df_yy = cov_df[cov_df[[year_colname]] == years_include[yy],]

      # if(all(toupper(cov_df_yy[[ds_colname]]) %in% ds_shapefile[[shapefile_ds_colname]])){
        
        cov_df_ordered = data.frame('ds_ordered'=ds_shapefile[[shapefile_ds_colname]], 'value'=rep(NA, length(ds_shapefile[[shapefile_ds_colname]])))
        for (i_ds in 1:length(cov_df_ordered$ds_ordered)){
          cur_row = which(toupper(cov_df_yy[[ds_colname]]) == toupper(cov_df_ordered$ds_ordered[i_ds]))
          if (length(cur_row)==1){
            cov_df_ordered$value[i_ds] = cov_df_yy[[value_colname]][cur_row]
          }
        }
        # iptp_2018_ordered = merge(LGAs_shapefile_order, iptp_2018, by.x='LGA_order', by.y='LGA', all.x=TRUE)
        col_cur = colorscale[sapply(floor((num_colors)*(cov_df_ordered$value - min_value) / (max_value - min_value))+1, min, num_colors)]
        col_cur[is.na(col_cur)] = 'grey'
        plot(ds_shapefile, col=col_cur, border=rgb(0.3,0.3,0.3), main=paste0(value_colname, ' - ', years_include[yy]))
      # } else{
      #   print('not all DS names matched between shapefile and intervention file')
      # }
    }
  if(pdf_filename != '') dev.off()
}

if(plot_map_flag){
  ds_shapefile = shapefile(ds_shapefile_filepath)
  years_include=round(seq(start_year, end_year, length.out=4))

  
  num_colors = 9
  colorscale = brewer.pal(num_colors,'RdYlBu')
  min_value=0
  max_value=1
}


# - - - - - - - - plot CM - - - - - - - - #
cm_input = cm_input[cm_input$year <= end_year,]

# U5 coverage
ggplot(cm_input, aes(x=year, y=U5_coverage, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  theme(legend.position = "none")

# adult coverage
ggplot(cm_input, aes(x=year, y=adult_coverage, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  theme(legend.position = "none")

# severe coverage
ggplot(cm_input, aes(x=year, y=severe_coverage, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  theme(legend.position = "none")


# create map of coverage
if(plot_map_flag){
  create_coverage_map(cov_df=cm_input, ds_colname='admin_name', value_colname='U5_coverage', year_colname='year', years_include=years_include, 
                      ds_shapefile=ds_shapefile, shapefile_ds_colname='NOMDEP', colorscale=colorscale, numcolors=numcolors, min_value=min_value, max_value=max_value, 
                      pdf_filename='')
  create_coverage_map(cov_df=cm_input, ds_colname='admin_name', value_colname='adult_coverage', year_colname='year', years_include=years_include, 
                      ds_shapefile=ds_shapefile, shapefile_ds_colname='NOMDEP', colorscale=colorscale, numcolors=numcolors, min_value=min_value, max_value=max_value, 
                      pdf_filename='')
  create_coverage_map(cov_df=cm_input, ds_colname='admin_name', value_colname='severe_coverage', year_colname='year', years_include=years_include, 
                      ds_shapefile=ds_shapefile, shapefile_ds_colname='NOMDEP', colorscale=colorscale, numcolors=numcolors, min_value=min_value, max_value=max_value, 
                      pdf_filename='')
  }

```



### SMC


```{r input_interventions_smc, message=FALSE, warning=FALSE, echo=FALSE, fig.width=3, fig.height=3}
if(plot_smc){
  # - - - - - - - - plot SMC - - - - - - - - #
if(!'smc_start' %in% colnames(smc_input)){
  smc_input$date = as.Date(paste0(start_year,'-01-01')) + smc_input$simday
} else{
  smc_input$date = as.Date(smc_input$smc_start, tryFormats = c("%Y-%m-%d", "%Y/%m/%d", "%m/%d/%Y"))
}

if(!'high_access_U5' %in% colnames(smc_input)){
  smc_input$high_access_U5 = 0.5
  smc_input$low_access_U5 = 0.5
  smc_input$high_access_5_10 = 0
  smc_input$low_access_5_10 = 1
  smc_input$coverage_high_access_U5 = smc_input$coverage_high_access 
  smc_input$coverage_low_access_U5 = smc_input$coverage_low_access 
  smc_input$coverage_high_access_5_10 = 0
  smc_input$coverage_low_access_5_10 = 0
}

# total fractions covered
smc_input$total_U5_coverage = smc_input$high_access_U5 * smc_input$coverage_high_access_U5 + (1-smc_input$high_access_U5) * smc_input$coverage_low_access_U5
smc_input$total_5_10_coverage = smc_input$high_access_5_10 * smc_input$coverage_high_access_5_10 + (1-smc_input$high_access_5_10) * smc_input$coverage_low_access_5_10

# plot fraction U5 covered
ggplot(smc_input, aes(x=date, y=total_U5_coverage, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  theme(legend.position = "none")

# plot fraction O5 covered
ggplot(smc_input, aes(x=date, y=total_5_10_coverage, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  theme(legend.position = "none")


# create map of coverage
if(plot_map_flag){
  create_coverage_map(cov_df=smc_input[smc_input$round==1,], ds_colname='admin_name', value_colname='total_U5_coverage', year_colname='year', years_include=years_include, 
                      ds_shapefile=ds_shapefile, shapefile_ds_colname='NOMDEP', colorscale=colorscale, numcolors=numcolors, min_value=min_value, max_value=max_value, 
                      pdf_filename='')
  create_coverage_map(cov_df=smc_input[smc_input$round==1,], ds_colname='admin_name', value_colname='total_5_10_coverage', year_colname='year', years_include=years_include, 
                      ds_shapefile=ds_shapefile, shapefile_ds_colname='NOMDEP', colorscale=colorscale, numcolors=numcolors, min_value=min_value, max_value=max_value, 
                      pdf_filename='')
}


}


```



### Mass distribution of LLINs

```{r input_interventions_mass_llin, message=FALSE, warning=FALSE, echo=FALSE, fig.width=3, fig.height=3}


# - - - - - - - - plot mass distribution LLIN - - - - - - - - #
mass_llin_input = mass_llin_input[,c('admin_name', 'itn_u5','itn_5_10','itn_o20', 'kill_initial', 'simday')]
mass_llin_input$year = start_year + floor(mass_llin_input$simday/365)

# coverage U5
ggplot(mass_llin_input, aes(x=year, y=itn_u5, group=admin_name)) +
  geom_line(aes(col=admin_name)) +
  theme(legend.position = "none")

# coverage 5-10
ggplot(mass_llin_input, aes(x=year, y=itn_5_10, group=admin_name)) +
  geom_line(aes(col=admin_name)) +
  theme(legend.position = "none")

# coverage >20
ggplot(mass_llin_input, aes(x=year, y=itn_o20, group=admin_name)) +
  geom_line(aes(col=admin_name)) +
  theme(legend.position = "none")


# killing rate
ggplot(mass_llin_input, aes(x=year, y=kill_initial, group=admin_name)) +
  geom_line(aes(col=admin_name)) +
  theme(legend.position = "none")


# create map of coverage
if(plot_map_flag){
  create_coverage_map(cov_df=mass_llin_input, ds_colname='admin_name', value_colname='itn_u5', year_colname='year', years_include=years_include,
                      ds_shapefile=ds_shapefile, shapefile_ds_colname='NOMDEP', colorscale=colorscale, numcolors=numcolors, min_value=min_value, max_value=max_value,
                      pdf_filename='')
  create_coverage_map(cov_df=mass_llin_input, ds_colname='admin_name', value_colname='itn_5_10', year_colname='year', years_include=years_include,
                      ds_shapefile=ds_shapefile, shapefile_ds_colname='NOMDEP', colorscale=colorscale, numcolors=numcolors, min_value=min_value, max_value=max_value,
                      pdf_filename='')
}


```



### ANC LLINs

```{r input_interventions_anc_llin, message=FALSE, warning=FALSE, echo=FALSE, fig.width=3, fig.height=3}


# - - - - - - - - plot ANC LLIN - - - - - - - - #
anc_llin_input = anc_llin_input[anc_llin_input$year<end_year,]
anc_llin_input = anc_llin_input[,c('admin_name', 'coverage', 'block_initial', 'kill_initial', 'year')]

# coverage
ggplot(anc_llin_input, aes(x=year, y=coverage, group=admin_name)) +
  geom_line(aes(col=admin_name)) +
  geom_point(aes(col=admin_name)) +
  theme(legend.position = "none")

# kill rate
ggplot(anc_llin_input, aes(x=year, y=kill_initial, group=admin_name)) +
  geom_line(aes(col=admin_name)) +
  geom_point(aes(col=admin_name)) +
  theme(legend.position = "none")

# block rate
ggplot(anc_llin_input, aes(x=year, y=block_initial, group=admin_name)) +
  geom_line(aes(col=admin_name)) +
  geom_point(aes(col=admin_name)) +
  theme(legend.position = "none")


```


</br>


## Intervention distributions in simulation

``` {r distribution_in_simulations, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}

names_to_plot = colnames(intervention_count_runMeans)[4:(dim(intervention_count_runMeans)[2]-1)]

for(nn in 1:length(names_to_plot)){
  gg = ggplot(intervention_count_runMeans, aes_string(x="date", y=names_to_plot[nn], group="admin_name")) +
    geom_line(aes(col=admin_name)) + 
    ggtitle(names_to_plot[nn]) + 
    theme(legend.position = "none")
  print(gg)
}

# print message on number of admins that have >0 counts for each intervention
for(cc in 4:(dim(intervention_count_runMeans)[2]-1)){
  num_admins_with_int = length(unique(intervention_count_runMeans$admin_name[which(intervention_count_runMeans[,..cc]>0)]))
  print(paste(num_admins_with_int, 'had at least one', colnames(intervention_count_runMeans)[cc], 'event'))
}


```

</br>

</br>


## Intervention coverages in simulation

``` {r coverage_in_simulations, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}


# to get rough proxy for coverage, divide by population size in DS
pop_sizes = pfpr_case_all_runMeans_annual[,c("year", "admin_name", "Statistical_Population", "New_Clinical_Cases")]
intervention_count_runMeans_annual2 = merge(intervention_count_runMeans_annual, pop_sizes, by=c("year", "admin_name"))
intervention_approx_coverage = as.data.table(intervention_count_runMeans_annual2)
intervention_approx_coverage[, CM_doses_per_capita := Received_Treatment/Statistical_Population]
intervention_approx_coverage[, CM_doses_per_clinical := Received_Treatment/(New_Clinical_Cases*Statistical_Population/1000)]
intervention_approx_coverage[, severe_CM_doses_per_capita := Received_Severe_Treatment/Statistical_Population]
intervention_approx_coverage[, bednet_per_capita := Bednet_Got_New_One/Statistical_Population]
intervention_approx_coverage[, SMC_doses_per_capita := Received_Campaign_Drugs/Statistical_Population]
intervention_approx_coverage[, IRS_per_capita := Received_IRS/Statistical_Population]



```


## Comparison of simulation versus input file interventions

### Case management

``` {r compare_coverage_in_simulations_inputs, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}

# merge input coverages
# CM
cm_input$U5_CM_input = cm_input$U5_coverage
cm_input$adult_CM_input = cm_input$adult_coverage
cm_input$severe_CM_input = cm_input$severe_coverage
intervention_approx_coverage = merge(intervention_approx_coverage, cm_input[,c('admin_name','year','U5_CM_input', 'adult_CM_input','severe_CM_input')], by=c('admin_name','year'), all.x=TRUE)
# SMC (just use round 1 input for U5)
if(plot_smc){
  smc_input$U5_SMC_input = smc_input$total_U5_coverage
  intervention_approx_coverage = merge(intervention_approx_coverage, smc_input[smc_input$round==1, c('admin_name','year','U5_SMC_input')], by=c('admin_name','year'), all.x=TRUE)
  intervention_approx_coverage$U5_SMC_input[is.na(intervention_approx_coverage$U5_SMC_input)] = 0
}

# mass distribution of LLINs
mass_llin_input$LLIN_dist_input = mass_llin_input$itn_u5
# add upper-case admin_name for merging since sometimes the LLIN file uses all caps
mass_llin_input$admin_name_upper = toupper(mass_llin_input$admin_name)
intervention_approx_coverage$admin_name_upper = toupper(intervention_approx_coverage$admin_name)
intervention_approx_coverage = merge(intervention_approx_coverage, mass_llin_input[, c('admin_name_upper','year','LLIN_dist_input')], by=c('admin_name_upper','year'), all.x=TRUE)
intervention_approx_coverage = intervention_approx_coverage[,-c('admin_name_upper')]

intervention_approx_coverage$U5_CM_input[is.na(intervention_approx_coverage$U5_CM_input)] = 0
intervention_approx_coverage$adult_CM_input[is.na(intervention_approx_coverage$adult_CM_input)] = 0
intervention_approx_coverage$severe_CM_input[is.na(intervention_approx_coverage$severe_CM_input)] = 0
intervention_approx_coverage$LLIN_dist_input[is.na(intervention_approx_coverage$LLIN_dist_input)] = 0


# - - - - - - - - - - - #
# create plots
# - - - - - - - - - - - #

####    CM    ####

# indicate whether there is no coverage in a year/admin, coverage is between 0 and 33%, between 33 and 66%, or above 66%
cur_int_df = intervention_approx_coverage[intervention_approx_coverage$U5_CM_input<0.01,]
if(dim(cur_int_df)[1]>0){
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=CM_doses_per_capita, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('admins without CM') +
    xlab('Admin-year') +
    ylab('doses per clinical case in sim')
}
cur_int_df = intervention_approx_coverage[intersect(which(intervention_approx_coverage$U5_CM_input>=0.01),which(intervention_approx_coverage$U5_CM_input<0.33)),]
if(dim(cur_int_df)[1]>0){
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=CM_doses_per_clinical, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('admins with U5 CM <33%') +
    xlab('Admin-year') +
    ylab('doses per clinical case in sim')
}
cur_int_df = intervention_approx_coverage[intersect(which(intervention_approx_coverage$U5_CM_input>=0.33),which(intervention_approx_coverage$U5_CM_input<0.66)),]
if(dim(cur_int_df)[1]>0){
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=CM_doses_per_clinical, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('admins with U5 CM between 33% and 66%') +
    xlab('Admin-year') +
    ylab('doses per clinical case in sim')
}
cur_int_df = intervention_approx_coverage[intervention_approx_coverage$U5_CM_input>=0.66,]
if(dim(cur_int_df)[1]>0){
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=CM_doses_per_clinical, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('admins with U5 CM above 66%') +
    xlab('Admin-year') +
    ylab('doses per clinical case in sim')
}

# Severe CM
cur_int_df = intervention_approx_coverage[intervention_approx_coverage$severe_CM_input<0.01,]
if(dim(cur_int_df)[1]>0){
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=severe_CM_doses_per_capita, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('admins without severe CM') +
    xlab('Admin-year') +
    ylab('doses administered per capita in sim')
}
cur_int_df = intervention_approx_coverage[intersect(which(intervention_approx_coverage$severe_CM_input>=0.01),which(intervention_approx_coverage$severe_CM_input<0.33)),]
if(dim(cur_int_df)[1]>0){
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=severe_CM_doses_per_capita, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('admins with severe CM < 33%') +
    xlab('Admin-year') +
    ylab('doses administered per capita in sim')
}
cur_int_df = intervention_approx_coverage[intersect(which(intervention_approx_coverage$severe_CM_input>=0.33),which(intervention_approx_coverage$severe_CM_input<0.66)),]
if(dim(cur_int_df)[1]>0){
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=severe_CM_doses_per_capita, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('admins with severe CM between 33% and 66%') +
    xlab('Admin-year') +
    ylab('doses administered per capita in sim')
}
cur_int_df = intervention_approx_coverage[intervention_approx_coverage$severe_CM_input>=0.66,]
if(dim(cur_int_df)[1]>0){
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=severe_CM_doses_per_capita, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('admins with severe CM above 66%') +
    xlab('Admin-year') +
    ylab('doses administered per capita in sim')
}



```


### SMC

```{r plot_smc_compare, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}
if (plot_smc){
    ####    SMC    ####
  # plot received and did not receive SMC
  cur_int_df = intervention_approx_coverage[intervention_approx_coverage$U5_SMC_input<0.01,]
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=Received_Campaign_Drugs, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('SMC doses for admins without SMC') +
    xlab('Admin-year') +
    ylab('doses administered in sim')
  cur_int_df = intervention_approx_coverage[intervention_approx_coverage$U5_SMC_input>=0.01,]
  cur_int_df$index = 1:dim(cur_int_df)[1]
  ggplot(cur_int_df, aes(x=index, y=Received_Campaign_Drugs, group=admin_name)) +
    geom_point(aes(col=year)) +
    ggtitle('SMC doses for admins with SMC') +
    xlab('Admin-year') +
    ylab('doses administered in sim')
}


```

### LLIN

```{r plot_llin_compare, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}

####    LLIN    ####
# plot received and did not receive LLIN
cur_int_df = intervention_approx_coverage[intervention_approx_coverage$LLIN_dist_input<0.001,]
cur_int_df$index = 1:dim(cur_int_df)[1]
ggplot(cur_int_df, aes(x=index, y=Bednet_Got_New_One, group=admin_name)) +
  geom_point(aes(col=year)) +
  ggtitle('admin-years without mass distributions') +
  xlab('Admin-year') +
  ylab('nets received in sim')
print('Admin-years where >50 nets received despite no mass distribution')
print(cur_int_df[cur_int_df$Bednet_Got_New_One>50,c('admin_name','year')])

cur_int_df = intervention_approx_coverage[intervention_approx_coverage$LLIN_dist_input>=0.001,]
cur_int_df$index = 1:dim(cur_int_df)[1]
ggplot(cur_int_df, aes(x=index, y=Bednet_Got_New_One, group=admin_name)) +
  geom_point(aes(col=year)) +
  ggtitle('admin-years with mass distributions') +
  xlab('Admin-year') +
  ylab('nets received in sim')




# if(plot_irs){
#   irs_input
# }


```


``` {r table_DS_counts, message=FALSE, warning=FALSE, echo=FALSE}


# each each year, how many DS/LGAs have distribution of various interventions
intervention_approx_coverage$someCM = 0
intervention_approx_coverage$someCM[intervention_approx_coverage$Received_Treatment>0.1] = 1
intervention_approx_coverage$someSMC = 0
intervention_approx_coverage$someSMC[intervention_approx_coverage$Received_Campaign_Drugs>0.1] = 1
intervention_approx_coverage$someLLIN = 0
intervention_approx_coverage$someLLIN[intervention_approx_coverage$Bednet_Got_New_One>0.1] = 1
intervention_approx_coverage$moreLLIN = 0
intervention_approx_coverage$someLLIN[intervention_approx_coverage$Bednet_Got_New_One>5] = 1


# mean values across runs (separate ds)
num_admin_with_distributions  <- intervention_approx_coverage %>% group_by(year) %>%  
  summarise_at(c('someCM', 'someSMC', 'someLLIN', 'moreLLIN'), sum) %>% ungroup() 

print(num_admin_with_distributions)



# which DS/LGAs fewer than 300 LLINs over all years?
inter_sums_all_years <- intervention_approx_coverage %>% group_by(admin_name) %>%  
  summarise_all(sum) %>% ungroup()


print(inter_sums_all_years$admin_name[inter_sums_all_years$Bednet_Got_New_One < 500])
```


</br>

</br>


# Malaria burden through time



## Annual mean across all admins, runs, and months
Note: average not weighted by admin population size

```{r plot_annual_mean_burdens, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}
# plot annual average (averaged across all runs, DS, and dates within a year)
ggplot(pfpr_case_all_annual, aes(x=year, y=PfHRP2_Prevalence)) +
  geom_line() + 
  # xlim(2010,2025) +
  theme(legend.position = "none")
ggplot(pfpr_case_all_annual, aes(x=year, y=New_Clinical_Cases)) +
  geom_line() + 
  # xlim(2010,2025) +
  theme(legend.position = "none")
ggplot(pfpr_case_u5_annual, aes(x=year, y=PfPR_U5)) +
  geom_line() + 
  # xlim(2010,2025) +
  theme(legend.position = "none")
ggplot(pfpr_case_u5_annual, aes(x=year, y=Cases_U5)) +
  geom_line() + 
  # xlim(2010,2025) +
  theme(legend.position = "none")

```

</br>

## Timeseries of mean burden across all admins and runs
Note: average not weighted by admin population size

```{r plot_mean_burden, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}
# mean value across all runs and all ds (not weighted by pop size)
# PfPR all age
ggplot(pfpr_case_all_mean, aes(x=date, y=PfHRP2_Prevalence)) +
  geom_line() + 
  theme(legend.position = "none")
# PfPR U5
ggplot(pfpr_case_u5_mean, aes(x=date, y=PfPR_U5)) +
  geom_line() + 
  theme(legend.position = "none")
# incidence all age
ggplot(pfpr_case_all_mean, aes(x=date, y=New_Clinical_Cases)) +
  geom_line() + 
  theme(legend.position = "none")+
  scale_x_date(date_breaks = "years" , date_labels = "%y")
# incidence U5
ggplot(pfpr_case_u5_mean, aes(x=date, y=Cases_U5)) +
  geom_line() + 
  theme(legend.position = "none")+
  scale_x_date(date_breaks = "years" , date_labels = "%y")



```


</br>

## Timeseries of mean burden across all runs, separated by admin
```{r plot_mean_burden_each_ds, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}



# mean values in each DS across runs
ggplot(pfpr_case_all_runMeans, aes(x=date, y=PfHRP2_Prevalence, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  theme(legend.position = "none")
# PfPR U5
ggplot(pfpr_case_u5_runMeans, aes(x=date, y=PfPR_U5, group=admin_name)) +
  geom_line(aes(col=admin_name)) + 
  theme(legend.position = "none")


```



## Comparison of burden in three-year intervals

Color indicates the mass-distribution of LLIN cycle year (2020=salmon, 2021=green, 2022=blue)

```{r plot_sim_compare_3_year_intervals, message=FALSE, warning=FALSE, echo=FALSE, fig.width=4, fig.height=3}

# if(start_year >2019){
#   
#   comparison_df = data.frame('admin_name' =pfpr_case_u5_annual_DS$admin_name[pfpr_case_u5_annual_DS$year == 2020], 
#                              '2020_u5_pfpr' = pfpr_case_u5_annual_DS$PfPR_U5[pfpr_case_u5_annual_DS$year == 2020], 
#                              '2023_u5_pfpr' = pfpr_case_u5_annual_DS$PfPR_U5[pfpr_case_u5_annual_DS$year == 2023], 
#                              '2026_u5_pfpr' = pfpr_case_u5_annual_DS$PfPR_U5[pfpr_case_u5_annual_DS$year == 2026], 
#                              '2029_u5_pfpr' = pfpr_case_u5_annual_DS$PfPR_U5[pfpr_case_u5_annual_DS$year == 2029],
#                              
#                              '2020_u5_cases' = pfpr_case_u5_annual_DS$Cases_U5[pfpr_case_u5_annual_DS$year == 2020], 
#                              '2023_u5_cases' = pfpr_case_u5_annual_DS$Cases_U5[pfpr_case_u5_annual_DS$year == 2023],
#                              '2026_u5_cases' = pfpr_case_u5_annual_DS$Cases_U5[pfpr_case_u5_annual_DS$year == 2026],
#                              '2029_u5_cases' = pfpr_case_u5_annual_DS$Cases_U5[pfpr_case_u5_annual_DS$year == 2029],
#   
#                              '2020_all_pfpr' = pfpr_case_all_annual_DS$PfHRP2_Prevalence[pfpr_case_all_annual_DS$year == 2020], 
#                              '2023_all_pfpr' = pfpr_case_all_annual_DS$PfHRP2_Prevalence[pfpr_case_all_annual_DS$year == 2023], 
#                              '2026_all_pfpr' = pfpr_case_all_annual_DS$PfHRP2_Prevalence[pfpr_case_all_annual_DS$year == 2026], 
#                              '2029_all_pfpr' = pfpr_case_all_annual_DS$PfHRP2_Prevalence[pfpr_case_all_annual_DS$year == 2029], 
#                              
#                              '2020_all_cases' = pfpr_case_all_annual_DS$New_Clinical_Cases[pfpr_case_all_annual_DS$year == 2020], 
#                              '2023_all_cases' = pfpr_case_all_annual_DS$New_Clinical_Cases[pfpr_case_all_annual_DS$year == 2023],
#                              '2026_all_cases' = pfpr_case_all_annual_DS$New_Clinical_Cases[pfpr_case_all_annual_DS$year == 2026],
#                              '2029_all_cases' = pfpr_case_all_annual_DS$New_Clinical_Cases[pfpr_case_all_annual_DS$year == 2029]
#                              )
#   
#    # specify which LLIN start year each DS has (determines color)
#   mass_llin_input_start = mass_llin_input[mass_llin_input$year<2023,c('admin_name','year')]
#   colnames(mass_llin_input_start) = c('admin_name','LLIN_year')
#   comparison_df = merge(comparison_df, mass_llin_input_start)
#   
#   # Scatterplots comparing U5 cases in years three yearrs apart
#   ggplot(comparison_df, aes(x=X2020_u5_cases, y=X2023_u5_cases)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average U5 annual incidence in 2020') + 
#     ylab('average U5 annual incidence in 2023') +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2023_u5_cases, y=X2026_u5_cases)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average U5 annual incidence in 2023') + 
#     ylab('average U5 annual incidence in 2026')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2026_u5_cases, y=X2029_u5_cases)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average U5 annual incidence in 2026') + 
#     ylab('average U5 annual incidence in 2029')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2020_u5_cases, y=X2029_u5_cases)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average U5 annual incidence in 2020') + 
#     ylab('average U5 annual incidence in 2029')  +
#     theme(legend.position = "none")
#   
#   # Scatterplots comparing all-age cases in years three yearrs apart
#   ggplot(comparison_df, aes(x=X2020_all_cases, y=X2023_all_cases)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average annual incidence in 2020') + 
#     ylab('average annual incidence in 2023')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2023_all_cases, y=X2026_all_cases)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average annual incidence in 2023') + 
#     ylab('average annual incidence in 2026')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2026_all_cases, y=X2029_all_cases)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average annual incidence in 2026') + 
#     ylab('average annual incidence in 2029')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2020_all_cases, y=X2029_all_cases)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average annual incidence in 2020') + 
#     ylab('average annual incidence in 2029')  +
#     theme(legend.position = "none")
#   
#   
#   # Scatterplots comparing U5 PfPR
#   ggplot(comparison_df, aes(x=X2020_u5_pfpr, y=X2023_u5_pfpr)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average U5 annual PfPR in 2020') + 
#     ylab('average U5 annual PfPR in 2023')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2023_u5_pfpr, y=X2026_u5_pfpr)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average U5 annual PfPR in 2023') + 
#     ylab('average U5 annual PfPR in 2026')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2026_u5_pfpr, y=X2029_u5_pfpr)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average U5 annual PfPR in 2026') + 
#     ylab('average U5 annual PfPR in 2029')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2020_u5_pfpr, y=X2029_u5_pfpr)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average U5 annual PfPR in 2020') + 
#     ylab('average U5 annual PfPR in 2029')  +
#     theme(legend.position = "none")
#   
#   
#   # Scatterplots comparing all-age PfPR
#   ggplot(comparison_df, aes(x=X2020_all_pfpr, y=X2023_all_pfpr)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average annual PfPR in 2020') + 
#     ylab('average annual PfPR in 2023')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2023_all_pfpr, y=X2026_all_pfpr)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average annual PfPR in 2023') + 
#     ylab('average annual PfPR in 2026')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2026_all_pfpr, y=X2029_all_pfpr)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average annual PfPR in 2026') + 
#     ylab('average annual PfPR in 2029')  +
#     theme(legend.position = "none")
#   ggplot(comparison_df, aes(x=X2020_all_pfpr, y=X2029_all_pfpr)) +
#     geom_point(aes(col=as.factor(LLIN_year)))  +
#     geom_abline(slope = 1, intercept=0, col='grey') + 
#     xlab('average annual PfPR in 2020') + 
#     ylab('average annual PfPR in 2029')  +
#     theme(legend.position = "none")
#   
# 
# }


```




